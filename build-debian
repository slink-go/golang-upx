
GOLANG_VERSION=1.25.6
DEBIAN_VERSION=trixie
#UPX_VERSION=4.2.2-3~bpo12+1
UPX_VERSION=4.2.4-1.1
GOLANGCI_LINT_VERSION=2.6.2

PLATFORMS=linux/arm/v7,linux/arm64/v8,linux/amd64

UPX_VERSION_UPD=$(echo ${UPX_VERSION} | tr '~\+' '_' | awk -F '_' '{print $1}')
UPX_VERSION=$(printf %s "${UPX_VERSION}" | jq -sRr @uri)

echo "GOLANG_VERSION=$GOLANG_VERSION"
echo "DEBIAN_VERSION=$DEBIAN_VERSION"
echo "UPX_VERSION=$UPX_VERSION"
echo "UPX_VERSION_UPD=$UPX_VERSION_UPD"
echo "GOLANGCI_LINT_VERSION=$GOLANGCI_LINT_VERSION"

source .env || true

if [ -z "$DOCKER_LOGIN" ]; then
    echo "Error: DOCKER_LOGIN not set"
    exit 1
fi
if [ -z "$DOCKER_PASSWORD" ]; then
    echo "Error: DOCKER_PASSWORD not set"
    exit 1
fi

echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_LOGIN" --password-stdin   && \
docker buildx create --use                                                   && \
docker buildx build                                                             \
    -f Dockerfile-debian                                                        \
    --build-arg "GOLANG_VERSION=${GOLANG_VERSION}"                              \
    --build-arg "DEBIAN_VERSION=${DEBIAN_VERSION}"                              \
    --build-arg "UPX_VERSION=${UPX_VERSION}"                                    \
    --build-arg "GOLANGCI_LINT_VERSION=${GOLANGCI_LINT_VERSION}"                \
    --platform ${PLATFORMS}                                                     \
    --push                                                                      \
    -t slinkgo/golang_upx:${GOLANG_VERSION}-${DEBIAN_VERSION}                   \
    -t slinkgo/golang_upx:${GOLANG_VERSION}-debian                              \
    -t slinkgo/golang_upx:debian                                                \
    -t slinkgo/golang_upx:${DEBIAN_VERSION} .
docker buildx rm
